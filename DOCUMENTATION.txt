===============================================================================
                         WORD2LATEX RESEARCH PROJECT
                      Hệ thống chuyển đổi Word (.docx) → LaTeX
===============================================================================

TỔNG QUAN DỰ ÁN
================
Dự án Word2Latex_Research là hệ thống chuyển đổi tài liệu Microsoft Word (.docx) 
sang định dạng LaTeX (.tex). Hệ thống xử lý đầy đủ các thành phần của tài liệu 
bao gồm văn bản, hình ảnh, bảng biểu, công thức toán học (OMML và OLE Equation), 
danh sách và định dạng style.

Điểm đặc biệt: Hệ thống có thể xử lý 2 loại công thức toán học chính:
- OMML (Office Math Markup Language) - định dạng XML của Word 2007+
- OLE Equation 3.0 (MTEF binary format) - định dạng cũ từ Equation Editor

KIẾN TRÚC HỆ THỐNG
==================

Hệ thống được thiết kế theo mô hình modular với 6 module chính:

1. chuyen_doi.py (Controller chính - 982 dòng)
   - Điều phối toàn bộ quá trình chuyển đổi
   - Đọc file .docx bằng python-docx
   - Phân tích cấu trúc tài liệu (paragraph, table, heading)
   - Tích hợp các module chuyên biệt
   - Sinh file LaTeX cuối cùng

2. config.py (Cấu hình - 198 dòng)
   - Định nghĩa namespace XML (OMML, W, OLE, VML, R, A, REL, WP)
   - Mapping style Word → LaTeX
   - Character mapping cho OMML
   - Pattern nhận diện heading
   - Đường dẫn XSLT mặc định

3. xu_ly_toan.py (Xử lý công thức OMML - 518 dòng)
   - Pipeline 3 tầng xử lý OMML:
     * Tầng 1: XSLT (OMML → MathML → LaTeX) - chính xác nhất
     * Tầng 2: Pandoc subprocess - fallback mạnh
     * Tầng 3: Parser thủ công đệ quy - fallback cuối
   - Xử lý fraction, matrix, integral, subscript/superscript
   - Mapping ký tự đặc biệt và symbol

4. xu_ly_ole_equation.py (Xử lý OLE Equation 3.0 - 809 dòng)
   - Parser MTEF v3 binary format
   - Trích xuất "Equation Native" stream từ OLE Compound File
   - Parse cây cú pháp MTEF (records, templates, characters)
   - Chuyển đổi template → LaTeX (fences, roots, fractions, integrals, matrices)
   - Unicode → LaTeX symbol mapping (100+ entries)

5. xu_ly_anh.py (Phân tích hình ảnh - 252 dòng)
   - Hệ thống scoring đánh giá chất lượng ảnh
   - Phân tích entropy, color variance, edge detection
   - Lọc ảnh trang trí/watermark (histogram analysis)
   - Tự động resize và tối ưu ảnh cho LaTeX

6. utils.py (Tiện ích - 77 dòng)
   - Escape ký tự đặc biệt LaTeX
   - Biên dịch LaTeX → PDF (XeLaTeX)
   - Dọn dẹp file tạm

THƯ VIỆN VÀ CÔNG NGHỆ
=====================

Thư viện Python chính:
- python-docx==1.1.0    : Đọc/parse file .docx
- lxml>=4.9.0          : XML processing, XSLT transformation
- Pillow==10.2.0       : Image processing và analysis
- olefile              : OLE Compound File parsing

Công cụ hệ thống:
- XSLT processor       : Chuyển OMML → MathML → LaTeX
- Pandoc (optional)    : Math conversion fallback
- XeLaTeX              : LaTeX → PDF compilation

Công nghệ xử lý:
- XML namespaces       : Truy cập chính xác elements
- XSLT transformation  : Template-based conversion
- Binary parsing       : MTEF format processing
- Regular expressions  : Pattern matching và cleanup
- Computer vision      : Image quality analysis

LUỒNG DỮ LIỆU CHÍNH
===================

Input: file.docx
     ↓
1. KHỞI TẠO
   - Tạo ChuyenDoiWordSangLatex instance
   - Load LaTeX template
   - Khởi tạo các bộ xử lý (BoXuLyToan, BoLocAnh)
     ↓
2. PHÂN TÍCH TÀI LIỆU  
   - Document.paragraphs → danh sách paragraph
   - Document.tables → danh sách table
   - Document.inline_shapes → embedded objects
     ↓
3. XỬ LÝ TỪNG THÀNH PHẦN
   3a. PARAGRAPH:
       - Text content → loc_ky_tu() → escaped LaTeX
       - Style mapping → LaTeX commands (\section, \textbf, etc.)
       - OMML math → xu_ly_toan.py → LaTeX math
       - OLE objects → xu_ly_ole_equation.py → LaTeX math
       - Images → xu_ly_anh.py → \includegraphics[]{}
   
   3b. TABLE:
       - Table structure → \begin{tabular}{} environment
       - Cell content → recursive paragraph processing
       - Merged cells → \multicolumn{}, \multirow{}
   
   3c. IMAGES:
       - Extract → save to images/ folder  
       - Quality analysis → keep/skip decision
       - Resize optimization → width/height parameters
     ↓
4. TÍCH HỢP KẾT QUẢ
   - Ghép nội dung vào LaTeX template
   - Xử lý danh sách (itemize/enumerate)
   - Format heading hierarchy
   - Cleanup redundant spacing
     ↓
5. XUẤT FILE
   Output: file.tex → XeLaTeX compilation → file.pdf

CHI TIẾT XỬ LÝ CÔNG THỨC
========================

A. OMML Processing (xu_ly_toan.py):
   OMML XML Element
        ↓
   Try XSLT: OMML2MML.XSL → MathML → LaTeX conversion
        ↓ (nếu fail)
   Try Pandoc: subprocess call với temporary file
        ↓ (nếu fail)  
   Manual Parser: đệ quy traverse XML tree
        ↓
   LaTeX formula output

B. OLE Equation Processing (xu_ly_ole_equation.py):
   OLE Binary Data
        ↓
   olefile.isOleFile() check
        ↓
   Extract "Equation Native" stream
        ↓
   MTEF Header parsing (version, platform, size)
        ↓
   MTEF Records parsing:
   - END (0): Terminate
   - LINE (1): Formula line
   - CHAR (2): Single character  
   - TMPL (3): Template (fraction, root, integral...)
   - SYM (13): Symbol character
        ↓
   Template processing:
   - Template 11 → \frac{}{} 
   - Template 10 → \sqrt[]{}
   - Template 15 → \int_{}^{}
   - Template 0-9 → fence pairs ()[]{}
        ↓
   Unicode → LaTeX symbol mapping
        ↓
   LaTeX formula output

PHÂN TÍCH HÌNH ẢNH (xu_ly_anh.py)
=================================

Scoring System (0.0 - 1.0):
- Entropy Score (30%): Đo độ phức tạp thông tin
- Color Variance (25%): Đo độ đa dạng màu sắc  
- Edge Detection (20%): Đo mật độ cạnh (Sobel filter)
- Size Score (15%): Ưu tiên ảnh có kích thước hợp lý
- Histogram Analysis (10%): Phát hiện ảnh đơn điệu

Quyết định lọc:
- Score >= 0.7: Ảnh nội dung quan trọng → giữ lại
- Score <  0.7: Ảnh trang trí/watermark → bỏ qua

TEMPLATE VÀ ĐỊNH DẠNG
====================

LaTeX Template Structure:
\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{xeCJK}                    % Vietnamese support
\usepackage{amsmath,amsfonts,amssymb} % Math packages
\usepackage{graphicx}                 % Images
\usepackage{array,tabularx}          % Advanced tables
\usepackage{enumitem}                 % Lists
\usepackage[margin=2.5cm]{geometry}   % Page margins

Style Mapping (Word → LaTeX):
- Normal           → (plain text)
- Heading 1        → \section{}
- Heading 2        → \subsection{}  
- Heading 3        → \subsubsection{}
- Title            → \title{}
- Strong/Bold      → \textbf{}
- Emphasis/Italic  → \textit{}
- List Paragraph   → \item

CÁCH SỬ DỤNG
============

1. Cài đặt dependencies:
   pip install -r requirements.txt

2. Chạy conversion:
   python src/chuyen_doi.py

3. Input files:
   - input_data/: Chứa file .docx và template LaTeX
   - Tự động detect file .docx đầu tiên trong thư mục

4. Output files:
   - output/: File .tex result
   - output/images/: Extracted images
   - Auto XeLaTeX compilation → PDF

KẾT QUẢ VÀ LIMITATIONS
======================

Đã implement thành công:
✓ Text và style conversion 
✓ Table processing với merged cells
✓ Image extraction và quality filtering
✓ OMML math → LaTeX (3-tier pipeline)  
✓ OLE Equation 3.0 → LaTeX (MTEF parser)
✓ List processing (itemize/enumerate)
✓ Heading hierarchy
✓ Auto XeLaTeX compilation

Limitations hiện tại:
- Header/Footer chưa được xử lý
- Complex table layouts có thể cần fine-tuning  
- Embedded charts/SmartArt chưa support
- Track changes/comments được ignore
- Some exotic OMML elements có thể fallback về image

TESTING VÀ VALIDATION
====================

Test cases đã verify:
- Formula 1: f(x) = ∫ₐᵇ ∜(5x-9) dx → LaTeX integral notation
- Formula 2: 3×3 matrix → LaTeX bmatrix environment  
- Mixed content documents với text + math + images
- Vietnamese text với XeLaTeX compilation
- Error handling cho corrupted OLE objects

Performance:
- Typical 10-page document: ~5-10 seconds processing
- Memory usage: ~50-100MB peak cho large documents
- XeLaTeX compilation: ~2-5 seconds thêm

CONTRIBUTION VÀ MỞ RỘNG
======================

Architecture cho phép mở rộng dễ dàng:
- Thêm math processor: implement method trong BoXuLyToan  
- Thêm image filter: mở rộng BoLocAnh.kiem_tra_anh_la_trang_tri()
- Thêm style mapping: cập nhật MAP_STYLE trong config.py
- Thêm template: tạo template selector trong MTEFParser

Code structure clean và modular, mỗi module có trách nhiệm rõ ràng,
dễ dàng maintain và extend cho future requirements.

===============================================================================
Tạo: February 2026
Tác giả: Word2LaTeX Research Team  
Version: 2.0 (with MTEF parser integration)
===============================================================================